<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulasi EFI Toyota Avanza K3-VE — Interaktif</title>
  <style>
    :root{--bg:#0f1724;--panel:#0b1220;--accent:#ffb020;--muted:#9aa4b2}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial;background:linear-gradient(180deg,#061022 0%, #081423 100%);color:#e6eef6}
    .wrap{display:grid;grid-template-columns:420px 1fr;gap:18px;padding:18px;height:100%}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{font-size:18px;margin:0 0 8px}
    p.small{color:var(--muted);margin-top:4px;font-size:13px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button{background:#0b2133;border:1px solid rgba(255,255,255,0.04);color:#e6eef6;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);color:#08121a;font-weight:600}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:rgba(0,0,0,0.18)}
    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .legend .item{display:flex;align-items:center;gap:8px;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .stage{display:flex;gap:10px;align-items:center}
    /* SVG area */
    .canvas{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center}
    svg{width:100%;height:calc(100vh - 120px)}
    .panel .row{margin-bottom:10px}
    .sensor-btn{display:inline-block;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
    .info{margin-top:10px;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));min-height:90px}
    footer{font-size:12px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" style="min-height:520px">
      <h1>Simulasi EFI — Toyota Avanza K3-VE</h1>
      <p class="small">Interaktif: klik sensor / tombol untuk melihat alur sinyal dan animasi. Cocok untuk siswa TKR belajar wiring dan alur ECU.</p>

      <div class="row">
        <!-- LIVE DATA PANEL -->
        <div class="panel" style="margin-top:10px;background:rgba(255,255,255,0.05);padding:10px;border-radius:10px">
          <h3 style="margin:0 0 6px;font-size:15px;color:#ffd26a">Live Data</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:13px">
            <div>RPM: <span id="ld-rpm">0</span></div>
            <div>TPS: <span id="ld-tps">0</span>%</div>
            <div>ECT: <span id="ld-ect">25</span>°C</div>
            <div>Injector PW: <span id="ld-inj">0.0</span> ms</div>
          </div>
        </div>
        <div class="controls">
          <button id="btn-start" class="primary">Start (Crank)</button>
          <button id="btn-idle">Idle</button>
          <button id="btn-accel">Akselerasi</button>
          <button id="btn-fault">Simulasi Fault</button>
          <button id="btn-reset">Reset</button>
        </div>
      </div>

      <div class="row">
        <div class="legend">
          <div class="item"><svg width="18" height="12"><rect width="18" height="12" fill="#ff4d4f"/></svg> Power / Relay</div>
          <div class="item"><svg width="18" height="12"><rect width="18" height="12" fill="#2ac769"/></svg> Sensor → ECU</div>
          <div class="item"><svg width="18" height="12"><rect width="18" height="12" fill="#4fa6ff"/></svg> ECU → Aktuator</div>
          <div class="item"><svg width="18" height="12"><rect width="18" height="12" fill="#e5b800"/></svg> Diagnostic / MIL</div>
        </div>
      </div>

      <div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div class="sensor-btn" data-sensor="ckp">Crank Pos (CKP)</div>
          <div class="sensor-btn" data-sensor="tps">Throttle (TPS)</div>
          <div class="sensor-btn" data-sensor="ect">Coolant Temp (ECT)</div>
          <div class="sensor-btn" data-sensor="o2">O2 Sensor</div>
          <!-- note: match this value with svg hit- ids -->
          <div class="sensor-btn" data-sensor="inj">Injektor</div>
        </div>
      </div>

      <div class="info" id="info">
        <strong>Status:</strong>
        <div id="info-text">Siap. Klik tombol "Start (Crank)" untuk mensimulasikan putaran mesin, atau klik sensor untuk penjelasan.</div>
      </div>

      <div class="status">
        <div><strong>ECU Connector:</strong> Multi-pin (simulasi) — menerima input sensor, mengeluarkan sinyal ke aktuator.</div>
        <footer>Created for SMK TKR — gunakan sebagai bahan ajar. Minta versi HTML siap-tempel untuk Blogger jika perlu.</footer>
      </div>
    </div>

    <div class="panel canvas">
      <!-- simplified diagram SVG -->
      <svg id="svg" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
        <defs>
          <filter id="glow"><feGaussianBlur stdDeviation="4" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>

        <!-- ECU box -->
        <rect id="ecu" x="50" y="50" width="220" height="180" rx="10" fill="#071426" stroke="#123" stroke-width="2"/>
        <text x="160" y="80" fill="#9cc3ff" font-size="16" text-anchor="middle">ECU</text>
        <text x="160" y="100" fill="#9cc3ff" font-size="12" text-anchor="middle">(Engine Control Unit)</text>

        <!-- sensors left -->
        <g id="sensors">
          <rect x="20" y="260" width="120" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="80" y="290" fill="#cce6ff" font-size="13" text-anchor="middle">Crank Pos (CKP)</text>

          <rect x="20" y="340" width="120" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="80" y="370" fill="#cce6ff" font-size="13" text-anchor="middle">TPS</text>

          <rect x="20" y="420" width="120" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="80" y="450" fill="#cce6ff" font-size="13" text-anchor="middle">ECT</text>

          <rect x="20" y="500" width="120" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="80" y="530" fill="#cce6ff" font-size="13" text-anchor="middle">O2 Sensor</text>
        </g>

        <!-- actuators right -->
        <g id="actuators">
          <rect x="1040" y="260" width="140" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="1110" y="295" fill="#cce6ff" font-size="13" text-anchor="middle">Injektor 1-4</text>

          <rect x="1040" y="350" width="140" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="1110" y="385" fill="#cce6ff" font-size="13" text-anchor="middle">Ignition Coil</text>

          <rect x="1040" y="440" width="140" height="60" rx="8" fill="#071426" stroke="#123"/>
          <text x="1110" y="475" fill="#cce6ff" font-size="13" text-anchor="middle">Fuel Pump Relay</text>
        </g>

        <!-- wires (paths) -->
        <path id="w-ckp" d="M140 290 C260 200, 300 150, 270 140 C260 135,220 110,270 110 L270 110 C360 110, 380 130, 270 160" stroke="#2ac769" stroke-width="4" fill="none" opacity="0.12"/>
        <path id="w-tps" d="M140 370 C240 300, 320 210, 300 180 C280 160,240 150,270 140" stroke="#2ac769" stroke-width="4" fill="none" opacity="0.12"/>
        <path id="w-ect" d="M140 450 C260 380, 360 260, 320 210 C300 190,260 170,270 160" stroke="#2ac769" stroke-width="4" fill="none" opacity="0.12"/>
        <path id="w-o2" d="M140 530 C300 430, 440 330, 470 260 C500 200,650 200,760 200" stroke="#2ac769" stroke-width="4" fill="none" opacity="0.12"/>

        <!-- ECU to injectors -->
        <path id="w-inj" d="M270 140 C420 140, 700 160, 1040 290" stroke="#4fa6ff" stroke-width="4" fill="none" opacity="0.12"/>
        <path id="w-ign" d="M270 160 C420 180, 720 240, 1040 380" stroke="#4fa6ff" stroke-width="4" fill="none" opacity="0.12"/>
        <path id="w-fuel" d="M270 180 C420 220, 760 320, 1040 470" stroke="#ff4d4f" stroke-width="4" fill="none" opacity="0.12"/>

        <!-- diagnostic / MIL -->
        <circle id="mil" cx="320" cy="100" r="12" fill="#e5b800" opacity="0.14"/>
        <text x="320" y="100" fill="#fff" font-size="10" text-anchor="middle" dy="4">MIL</text>

        <!-- small labels -->
        <text x="160" y="135" fill="#9cc3ff" font-size="12" text-anchor="middle">ECU connector pins</text>

        <!-- animated overlay paths (same shapes but stroke-dasharray for animation) -->
        <path id="a-ckp" d="M140 290 C260 200, 300 150, 270 140 C260 135,220 110,270 110 L270 110 C360 110, 380 130, 270 160" stroke="#2ac769" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
        <path id="a-tps" d="M140 370 C240 300, 320 210, 300 180 C280 160,240 150,270 140" stroke="#2ac769" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
        <path id="a-ect" d="M140 450 C260 380, 360 260, 320 210 C300 190,260 170,270 160" stroke="#2ac769" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
        <path id="a-o2" d="M140 530 C300 430, 440 330, 470 260 C500 200,650 200,760 200" stroke="#2ac769" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>

        <path id="a-inj" d="M270 140 C420 140, 700 160, 1040 290" stroke="#4fa6ff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
        <path id="a-ign" d="M270 160 C420 180, 720 240, 1040 380" stroke="#4fa6ff" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>
        <path id="a-fuel" d="M270 180 C420 220, 760 320, 1040 470" stroke="#ff4d4f" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" opacity="0"/>

        <!-- small icons for clickable sensors (invisible rects with pointer) -->
        <rect id="hit-ckp" x="20" y="260" width="120" height="60" fill="transparent" cursor="pointer"/>
        <rect id="hit-tps" x="20" y="340" width="120" height="60" fill="transparent" cursor="pointer"/>
        <rect id="hit-ect" x="20" y="420" width="120" height="60" fill="transparent" cursor="pointer"/>
        <rect id="hit-o2" x="20" y="500" width="120" height="60" fill="transparent" cursor="pointer"/>

        <!-- clickable injectors group -->
        <rect id="hit-inj" x="1040" y="260" width="140" height="60" fill="transparent" cursor="pointer"/>

      </svg>
    </div>
  </div>

  <script>
    // helper: safe get element by id
    function $id(id){ return document.getElementById(id); }

    // helper: animate path by strokeDashoffset (safely)
    function animatePath(el, duration=800){
      if(!el) return; // safety
      try{
        el.style.opacity = 1;
        const length = el.getTotalLength();
        el.style.strokeDasharray = length;
        el.style.strokeDashoffset = length;
        el.style.transition = `stroke-dashoffset ${duration}ms linear, opacity ${Math.max(80,duration/4)}ms linear`;
        requestAnimationFrame(()=> el.style.strokeDashoffset = '0');
        // hide after animation
        setTimeout(()=>{ el.style.opacity = 0; el.style.transition = ''; }, duration+200);
      }catch(e){ console.warn('animatePath failed', e); }
    }

    // safe addEvent helper (assumes click events)
    function safeOn(id, handler){ const el = $id(id); if(el) el.addEventListener('click', handler); else console.warn('Element not found for', id); }

    // update live data display
    function updateLiveData(obj){
      if(obj.rpm!==undefined) document.getElementById('ld-rpm').innerText = obj.rpm;
      if(obj.tps!==undefined) document.getElementById('ld-tps').innerText = obj.tps;
      if(obj.ect!==undefined) document.getElementById('ld-ect').innerText = obj.ect;
      if(obj.inj!==undefined) document.getElementById('ld-inj').innerText = obj.inj;
    }

    function setInfo(text){ const el = $id('info-text'); if(el) el.innerHTML = text; }

    // button handlers (use safeOn)
    safeOn('btn-start', ()=>{
      // update live data and run animations
      updateLiveData({rpm: 250, tps: 2, ect: 30, inj: 3.0});
      setInfo('Cranking: CKP aktif → ECU membaca posisi poros engkol. ECU mengaktifkan fuel pump relay & mengirim trigger ke injektor dan koil.');
      animatePath($id('a-ckp'),500);
      setTimeout(()=> animatePath($id('a-inj'),700),200);
      setTimeout(()=> animatePath($id('a-ign'),800),300);
      setTimeout(()=> animatePath($id('a-fuel'),900),350);
    });

    safeOn('btn-idle', ()=>{
      updateLiveData({rpm: 750, tps: 1, ect: 85, inj: 2.5});
      setInfo('Idle: TPS kecil, ECU mempertahankan duty injector rendah dan mengatur ISC (idle) agar RPM stabil. O2 membaca campuran untuk koreksi.' );
      animatePath($id('a-tps'),400);
      setTimeout(()=> animatePath($id('a-inj'),700),150);
      setTimeout(()=> animatePath($id('a-o2'),900),350);
    });

    safeOn('btn-accel', ()=>{
      updateLiveData({rpm: 2800, tps: 45, ect: 88, inj: 6.5});
      setInfo('Akselerasi: TPS meningkat → ECU menambah injeksi & advance ignition. Fuel pump & injector duty naik.' );
      animatePath($id('a-tps'),350);
      setTimeout(()=> animatePath($id('a-inj'),550),150);
      setTimeout(()=> animatePath($id('a-ign'),650),200);
    });

    safeOn('btn-fault', ()=>{
      setInfo('Simulasi Fault: O2 sensor open-circuit. ECU masuk mode limp-home / mematikan koreksi closed-loop. MIL ON.');
      const mil = $id('mil'); if(mil){ mil.style.opacity = 1; mil.style.fill = '#e5b800'; }
      let t=0; const id=setInterval(()=>{ if(!mil){ clearInterval(id); return;} mil.style.opacity = (t%2?0.2:1); t++; if(t>5){ clearInterval(id); if(mil) mil.style.opacity = 1; } },300);
      const a = $id('a-o2'); if(a){ a.style.opacity=1; a.style.stroke='#ff4d4f'; a.style.strokeWidth='8'; setTimeout(()=>{ if(a){ a.style.opacity=0; a.style.stroke='#2ac769'; a.style.strokeWidth='6'; } },1200); }
    });

    safeOn('btn-reset', ()=>{
      updateLiveData({rpm: 0, tps: 0, ect: 25, inj: 0});
      setInfo('Reset ke kondisi awal.');
      const mil = $id('mil'); if(mil) mil.style.opacity = 0.14;
    });

    // clickable sensors in svg (safe)
    safeOn('hit-ckp', ()=>{ setInfo('Crank Position Sensor (CKP): memberi sinyal RPM & posisi TDC ke ECU. Tanpa CKP, mesin tidak akan menyala.'); animatePath($id('a-ckp'),700); });
    safeOn('hit-tps', ()=>{ setInfo('Throttle Position Sensor (TPS): membaca bukaan throttle agar ECU tahu beban.'); animatePath($id('a-tps'),700); });
    safeOn('hit-ect', ()=>{ setInfo('Engine Coolant Temp (ECT): membantu ECU menambahkan bahan bakar saat mesin dingin (cold enrichment).'); animatePath($id('a-ect'),700); });
    safeOn('hit-o2', ()=>{ setInfo('O2 Sensor (Lambda): menginformasikan ke ECU kelebihan/kurangnya bahan bakar, dipakai untuk closed-loop control.'); animatePath($id('a-o2'),900); });
    safeOn('hit-inj', ()=>{ setInfo('Injektor: aktuator yang menyemprotkan bahan bakar berdasarkan pulsa dari ECU. Perhatikan duty cycle & waktu buka.' ); animatePath($id('a-inj'),700); });

    // wire clickable buttons in left panel (match data-sensor -> hit- ids)
    document.querySelectorAll('.sensor-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const data = btn.getAttribute('data-sensor');
        const hitId = 'hit-' + data; // data values must match hit- ids in svg
        const target = $id(hitId);
        if(target){
          // dispatch a native click event safely
          try{ target.dispatchEvent(new MouseEvent('click', {bubbles:true,cancelable:true})); }
          catch(e){ console.warn('dispatchEvent failed', e); if(typeof target.click === 'function') target.click(); }
        }else{
          console.warn('No target element for', hitId);
          setInfo('Elemen interaktif belum tersedia: ' + hitId);
        }
      });
    });

    // initial state
    const milEl = $id('mil'); if(milEl) milEl.style.opacity = 0.14;

  </script>
</body>
</html>
